name: Update Middleware Version
on:
  repository_dispatch:
    types: [middleware-release]

# Permissions for creating branches and PRs
permissions:
  contents: write
  pull-requests: write

jobs:
  update-middleware:
    name: Update middleware and create PR
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6.0.1
        with:
          fetch-depth: 1
          persist-credentials: true

      - name: Setup pnpm
        uses: pnpm/action-setup@v4.2.0
        # Version is automatically read from package.json packageManager field

      - name: Setup Node.js
        uses: actions/setup-node@v6.2.0
        with:
          node-version: "lts/*"
          registry-url: https://registry.npmjs.org
          cache: pnpm

      - name: Install dependencies
        run: |
          # Set safer npm config
          npm config set ignore-scripts true
          npm config set audit true

          # Install dependencies with frozen lockfile for reproducibility
          pnpm install --ignore-scripts --frozen-lockfile
        env:
          # Disable progress bars for cleaner logs
          NPM_CONFIG_PROGRESS: "false"

      - name: Run post-install scripts
        run: |
          pnpm prepare

      - name: Build action and extract middleware version
        id: build
        run: |
          # Run build and capture output
          BUILD_OUTPUT=$(pnpm run build 2>&1)
          echo "$BUILD_OUTPUT"

          # Extract middleware version from build output
          # The build logs contain: "Building with @appwarden/middleware@X.Y.Z"
          MIDDLEWARE_VERSION=$(echo "$BUILD_OUTPUT" | grep -oP 'Building with @appwarden/middleware@\K[0-9]+\.[0-9]+\.[0-9]+' || true)

          if [[ -z "$MIDDLEWARE_VERSION" ]]; then
            echo "::error::Failed to extract middleware version from build output"
            echo "Build output was:"
            echo "$BUILD_OUTPUT"
            exit 1
          fi

          echo "Extracted middleware version: $MIDDLEWARE_VERSION"
          echo "middleware_version=$MIDDLEWARE_VERSION" >> $GITHUB_OUTPUT

      - name: Create changeset file
        run: |
          VERSION="${{ steps.build.outputs.middleware_version }}"
          CHANGESET_FILE=".changeset/middleware-update-$(date +%Y%m%d%H%M%S).md"

          cat > "$CHANGESET_FILE" << EOF
          ---
          "@appwarden/build-cloudflare-action": minor
          ---

          Update @appwarden/middleware to version ${VERSION}
          EOF

          echo "Created changeset file: $CHANGESET_FILE"

      - name: Commit and push changes
        run: |
          VERSION="${{ steps.build.outputs.middleware_version }}"
          BRANCH_NAME="update-middleware-${VERSION}"

          # Configure git
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # Create a new branch
          git checkout -b "$BRANCH_NAME"

          # Add all changes (dist files and changeset)
          git add dist/
          git add .changeset/

          # Commit changes
          git commit -m "chore(release): update middleware version to ${VERSION}"

          # Push the branch
          git push origin "$BRANCH_NAME"

          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
        id: commit

      - name: Create Pull Request
        run: |
          VERSION="${{ steps.build.outputs.middleware_version }}"
          BRANCH_NAME="${{ steps.commit.outputs.branch_name }}"

          # Get payload data from repository_dispatch event
          MIDDLEWARE_VERSION="${{ github.event.client_payload.middleware_version }}"
          RELEASE_TAG="${{ github.event.client_payload.release_tag }}"
          RELEASE_URL="${{ github.event.client_payload.release_url }}"

          # Create PR body
          PR_BODY=$(cat << EOF
          ## Middleware Release Update

          This PR updates the build to use the latest middleware version.

          ### Release Information
          - **Middleware Version:** ${MIDDLEWARE_VERSION:-$VERSION}
          - **Release Tag:** ${RELEASE_TAG:-N/A}
          - **Release URL:** ${RELEASE_URL:-N/A}

          ### Changes
          - Rebuilt \`dist/\` with the latest @appwarden/middleware@${VERSION}
          - Added changeset for version bump

          ---
          *This PR was automatically generated by the middleware-release workflow.*
          EOF
          )

          # Set default repo for gh commands
          gh repo set-default "${{ github.repository }}"

          # Create the pull request
          gh pr create \
            --base main \
            --head "$BRANCH_NAME" \
            --title "chore(release): update middleware version to ${VERSION}" \
            --body "$PR_BODY"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
